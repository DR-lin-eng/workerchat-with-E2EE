# 部署说明

## 项目概述

这是一个基于 Cloudflare Workers 的端到端加密聊天室，支持两种文件传输方式：

1. **WebSocket 实时传输**（推荐）- 兼容性好，支持所有网络环境
2. **WebRTC P2P 传输**（可选）- 点对点传输，需要网络支持

## 功能特性

- 🔒 端到端 PGP 加密
- ⚡ WebSocket 实时文件传输
- 🔍 MD5 文件完整性验证
- 🌐 可选的 WebRTC P2P 传输
- 📱 移动端优化
- 🏠 房间系统

## 部署步骤

### 1. 环境准备

确保已安装 Node.js 和 npm：

```bash
node --version  # 应该 >= 16
npm --version
```

### 2. 安装依赖

```bash
npm install
```

### 3. 开发环境运行

```bash
npm run dev
```

访问 `http://localhost:8787` 查看应用。

### 4. 生产环境部署

```bash
npm run deploy
```

部署完成后，你会得到一个 Cloudflare Workers 的 URL。

## 页面说明

### 主页面
- `/` 或 `/index.html` - 功能选择页面

### 功能页面
- `/realtime.html` - WebSocket 实时文件传输（推荐）
- `/webrtc.html` - WebRTC P2P 文件传输（可选）

## 使用方法

### 1. 访问应用
访问部署后的 URL，选择传输方式。

### 2. 密钥管理
- 首次使用需要生成或导入 PGP 密钥对
- 私钥存储在本地浏览器中
- 可以导出公钥分享给其他用户

### 3. 加入房间
- 可以指定房间ID加入特定房间
- 或者让系统自动生成房间ID

### 4. 文件传输

#### WebSocket 实时传输
1. 点击用户列表中的"发送文件"按钮
2. 选择文件，系统自动计算 MD5
3. 等待对方确认接收
4. 文件分片传输，实时显示进度
5. 接收完成后自动验证 MD5 并下载

#### WebRTC P2P 传输
1. 点击其他用户建立 P2P 连接
2. 连接成功后可以直接发送文件
3. 文件直接在用户间传输

## 技术架构

### 后端
- **Cloudflare Workers** - 无服务器运行环境
- **Durable Objects** - 持久化状态管理
- **WebSocket** - 实时通信

### 前端
- **原生 JavaScript** - 无框架依赖
- **OpenPGP.js** - 端到端加密
- **WebRTC API** - P2P 连接（可选）
- **File API** - 文件处理

### 安全特性
- **PGP 加密** - 消息端到端加密
- **MD5 验证** - 文件完整性检查
- **WSS 连接** - 传输层加密
- **本地密钥存储** - 私钥不离开浏览器

## 配置选项

### 文件传输限制
在 `src/ChatRoom.ts` 中可以调整：

```typescript
// 最大文件大小 (默认 500MB)
const maxFileSize = 500 * 1024 * 1024;

// 最大分片大小 (默认 128KB)
const maxChunkSize = 128 * 1024;
```

### 分片大小
在前端可以调整分片大小：

```typescript
// 默认 64KB 分片
private chunkSize = 64 * 1024;
```

## 故障排除

### 1. 编译错误
如果遇到 TypeScript 类型错误：

```bash
npx wrangler types
```

### 2. WebRTC 连接失败
- 检查网络是否支持 WebRTC
- 企业网络可能阻止 WebRTC 连接
- 建议使用 WebSocket 实时传输

### 3. 文件传输失败
- 检查文件大小是否超过限制
- 确保网络连接稳定
- 查看浏览器控制台错误信息

### 4. 密钥问题
- 确保 PGP 密钥格式正确
- 检查密钥是否已正确导入
- 私钥和公钥必须匹配

## 性能优化

### 1. 文件传输优化
- 调整分片大小以适应网络环境
- 增加传输间隔以减少服务器负载
- 实现断点续传（未来功能）

### 2. 内存优化
- 大文件分片处理避免内存溢出
- 及时清理传输完成的临时数据
- 限制同时传输的文件数量

### 3. 网络优化
- 使用 CDN 加速静态资源
- 启用 Cloudflare 的性能优化功能
- 考虑使用 TURN 服务器改善 WebRTC 连接

## 扩展功能

### 可能的改进
1. **断点续传** - 支持大文件传输中断后继续
2. **多文件传输** - 批量文件传输队列
3. **传输加密** - 在文件传输层面添加额外加密
4. **用户权限** - 房间管理员和权限控制
5. **传输历史** - 记录和统计传输历史
6. **移动端 App** - 原生移动应用

### 集成选项
1. **数据库集成** - 持久化用户和房间信息
2. **身份验证** - OAuth 或其他身份验证系统
3. **文件存储** - 可选的文件备份到云存储
4. **监控告警** - 系统监控和错误告警

## 许可证

本项目使用 AGPLv3 许可证，详见 LICENSE 文件。

## 支持

如有问题或建议，请提交 Issue 或 Pull Request。