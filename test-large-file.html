<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大文件传输测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .file-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .chunk-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>大文件传输测试</h1>
    
    <div class="test-section">
        <h2>传输限制说明</h2>
        <div class="status info">
            <strong>实时文件传输规则:</strong><br>
            • 文件总大小：<strong>无限制</strong><br>
            • 单个分片大小：<strong>最大 500MB</strong><br>
            • 分片大小会根据文件大小自动优化<br>
            • 支持超大文件（TB级别）传输
        </div>
    </div>
    
    <div class="test-section">
        <h2>文件大小限制测试</h2>
        <p>测试不同大小的文件是否能通过大小验证</p>
        
        <input type="file" id="fileInput" />
        <button onclick="testFileSize()">测试文件大小</button>
        
        <div id="fileSizeResult"></div>
    </div>
    
    <div class="test-section">
        <h2>分片大小计算测试</h2>
        <p>测试动态分片大小计算是否正确</p>
        
        <button onclick="testChunkSizes()">测试分片大小计算</button>
        
        <div id="chunkSizeResult"></div>
    </div>
    
    <div class="test-section">
        <h2>创建测试文件</h2>
        <p>创建不同大小的测试文件用于传输测试</p>
        
        <button onclick="createTestFile(1024 * 1024)">创建 1MB 测试文件</button>
        <button onclick="createTestFile(10 * 1024 * 1024)">创建 10MB 测试文件</button>
        <button onclick="createTestFile(100 * 1024 * 1024)">创建 100MB 测试文件</button>
        <button onclick="createTestFile(1024 * 1024 * 1024)">创建 1GB 测试文件</button>
        <button onclick="createTestFile(5 * 1024 * 1024 * 1024)">创建 5GB 测试文件</button>
        <button onclick="createTestFile(10 * 1024 * 1024 * 1024)">创建 10GB 测试文件</button>
        
        <div id="testFileResult"></div>
    </div>

    <script>
        // 计算最优分片大小的函数（与后端保持一致）
        function calculateOptimalChunkSize(fileSize) {
            const maxChunkSize = 500 * 1024 * 1024; // 500MB 最大分片
            
            if (fileSize < 10 * 1024 * 1024) { // < 10MB
                return 64 * 1024; // 64KB
            } else if (fileSize < 100 * 1024 * 1024) { // < 100MB
                return 256 * 1024; // 256KB
            } else if (fileSize < 1024 * 1024 * 1024) { // < 1GB
                return 512 * 1024; // 512KB
            } else if (fileSize < 10 * 1024 * 1024 * 1024) { // < 10GB
                return 1024 * 1024; // 1MB
            } else if (fileSize < 100 * 1024 * 1024 * 1024) { // < 100GB
                return 10 * 1024 * 1024; // 10MB
            } else { // >= 100GB
                return maxChunkSize; // 500MB
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 测试文件大小限制
        function testFileSize() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('fileSizeResult');
            
            if (!fileInput.files.length) {
                resultDiv.innerHTML = '<div class="status error">请先选择一个文件</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const maxChunkSize = 500 * 1024 * 1024; // 500MB 单个分片限制
            
            let result = `<div class="file-info">
                <strong>文件信息:</strong><br>
                名称: ${file.name}<br>
                大小: ${formatFileSize(file.size)}<br>
                类型: ${file.type || '未知'}
            </div>`;
            
            // 实时文件传输无总大小限制
            result += '<div class="status success">✅ 实时文件传输无文件大小限制</div>';
            
            // 计算分片信息
            const chunkSize = calculateOptimalChunkSize(file.size);
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            // 检查分片大小是否符合要求
            if (chunkSize > maxChunkSize) {
                result += '<div class="status error">❌ 计算的分片大小超过500MB限制</div>';
            } else {
                result += '<div class="status success">✅ 分片大小符合要求</div>';
            }
            
            result += `<div class="chunk-info">
                <strong>分片信息:</strong><br>
                分片大小: ${formatFileSize(chunkSize)}<br>
                总分片数: ${totalChunks.toLocaleString()}<br>
                单个分片限制: ${formatFileSize(maxChunkSize)}<br>
                预估传输时间: ${estimateTransferTime(file.size)}
            </div>`;
            
            resultDiv.innerHTML = result;
        }

        // 测试分片大小计算
        function testChunkSizes() {
            const testSizes = [
                1024 * 1024,                    // 1MB
                5 * 1024 * 1024,               // 5MB
                50 * 1024 * 1024,              // 50MB
                500 * 1024 * 1024,             // 500MB
                1024 * 1024 * 1024,            // 1GB
                5 * 1024 * 1024 * 1024,        // 5GB
                10 * 1024 * 1024 * 1024,       // 10GB
                100 * 1024 * 1024 * 1024,      // 100GB
                1024 * 1024 * 1024 * 1024      // 1TB
            ];
            
            let result = '<div class="status info">分片大小计算结果:</div>';
            
            testSizes.forEach(size => {
                const chunkSize = calculateOptimalChunkSize(size);
                const totalChunks = Math.ceil(size / chunkSize);
                
                result += `<div class="chunk-info">
                    文件大小: ${formatFileSize(size)} → 
                    分片大小: ${formatFileSize(chunkSize)} → 
                    分片数量: ${totalChunks.toLocaleString()}
                </div>`;
            });
            
            document.getElementById('chunkSizeResult').innerHTML = result;
        }

        // 创建测试文件
        function createTestFile(size) {
            const resultDiv = document.getElementById('testFileResult');
            resultDiv.innerHTML = '<div class="status info">正在创建测试文件...</div>';
            
            try {
                // 创建指定大小的测试数据
                const chunkSize = 1024 * 1024; // 1MB chunks for creation
                const chunks = [];
                const totalChunks = Math.ceil(size / chunkSize);
                
                for (let i = 0; i < totalChunks; i++) {
                    const currentChunkSize = Math.min(chunkSize, size - i * chunkSize);
                    const chunk = new Uint8Array(currentChunkSize);
                    
                    // 填充一些测试数据
                    for (let j = 0; j < currentChunkSize; j++) {
                        chunk[j] = (i + j) % 256;
                    }
                    
                    chunks.push(chunk);
                }
                
                const blob = new Blob(chunks, { type: 'application/octet-stream' });
                const fileName = `test-file-${formatFileSize(size).replace(' ', '')}.bin`;
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                
                URL.revokeObjectURL(url);
                
                resultDiv.innerHTML = `<div class="status success">
                    ✅ 成功创建 ${formatFileSize(size)} 测试文件: ${fileName}
                </div>`;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">
                    ❌ 创建测试文件失败: ${error.message}
                </div>`;
            }
        }

        // 估算传输时间
        function estimateTransferTime(fileSize) {
            // 假设传输速度为 1MB/s (实际速度会根据网络条件变化)
            const speedMBps = 1;
            const timeSec = fileSize / (speedMBps * 1024 * 1024);
            
            if (timeSec < 60) {
                return `约 ${Math.ceil(timeSec)} 秒`;
            } else if (timeSec < 3600) {
                return `约 ${Math.ceil(timeSec / 60)} 分钟`;
            } else {
                return `约 ${Math.ceil(timeSec / 3600)} 小时`;
            }
        }

        // 页面加载时运行分片大小测试
        window.onload = function() {
            testChunkSizes();
        };
    </script>
</body>
</html>